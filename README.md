# Микросервисная система заказов и платежей

**Автор:** [Немыкин Михаил]  
**Группа:** [БПИ238]

Данный проект представляет собой микросервисную архитектуру для обработки заказов и платежей. Система состоит из нескольких сервисов, которые взаимодействуют между собой для обеспечения функциональности интернет-магазина.

## Архитектура системы

Система состоит из следующих компонентов:

1. **API Gateway** - отвечает за маршрутизацию запросов к соответствующим сервисам
2. **Orders Service** - управление заказами (создание, просмотр списка, проверка статуса)
3. **Payments Service** - управление платежами (создание счета, пополнение баланса, проверка баланса)
4. **Redis** - используется как брокер сообщений для асинхронного взаимодействия между сервисами
5. **PostgreSQL** - базы данных для хранения информации о заказах и платежах
6. **Frontend** - пользовательский интерфейс для взаимодействия с системой

### Паттерны, используемые в проекте:

- **Transactional Outbox** в Order Service
- **Transactional Inbox и Outbox** в Payments Service
- **Exactly once** семантика при списании денег

## Запуск системы

### Предварительные требования

- Docker и Docker Compose
- .NET SDK 8.0 (для разработки)

### Запуск с использованием Docker Compose

1. Запустите систему с помощью Docker Compose:
   ```
   docker-compose up -d
   ```

3. После успешного запуска, сервисы будут доступны по следующим адресам:
   - Frontend: http://localhost
   - API Gateway: http://localhost:5000
   - Orders Service: http://localhost:5003
   - Payments Service: http://localhost:5002
   - Swagger UI: http://localhost:5000/swagger

### Остановка и очистка системы

1. Остановка контейнеров:
   ```
   docker-compose down
   ```

2. Остановка контейнеров и удаление томов (очистка баз данных):
   ```
   docker-compose down -v
   ```
   
3. Просмотр логов:
   ```
   docker-compose logs -f [service-name]
   ```
   Например: `docker-compose logs -f payments-service`

## Тестирование API

### Использование Frontend

Самый простой способ протестировать систему - использовать веб-интерфейс, доступный по адресу http://localhost. Интерфейс предоставляет доступ ко всем функциям системы:

1. **Управление аккаунтом**:
   - Создание аккаунта
   - Проверка баланса
   - Пополнение баланса

2. **Управление заказами**:
   - Создание заказа
   - Просмотр списка заказов
   - Просмотр деталей заказа

### Использование Swagger

Для тестирования API напрямую можно использовать Swagger UI:

1. Откройте Swagger UI по адресу http://localhost:5000/swagger
2. Выберите нужный эндпоинт и выполните запрос

### Использование Postman или curl

#### Payments Service API:

1. **Создание счета**:
   ```
   POST http://localhost:5000/payments/create?userId=user123
   ```

2. **Пополнение счета**:
   ```
   POST http://localhost:5000/payments/topup?userId=user123&amount=100
   ```

3. **Проверка баланса**:
   ```
   GET http://localhost:5000/payments/balance?userId=user123
   ```

#### Orders Service API:

1. **Создание заказа**:
   ```
   POST http://localhost:5000/orders?userId=user123&amount=50&description=Test%20Order
   ```

2. **Получение списка заказов пользователя**:
   ```
   GET http://localhost:5000/orders?userId=user123
   ```

3. **Получение информации о конкретном заказе**:
   ```
   GET http://localhost:5000/orders/{orderId}
   ```

## Сценарии использования

### Полный цикл заказа:

1. Создайте аккаунт для пользователя:
   ```
   POST http://localhost:5000/payments/create?userId=user123
   ```

2. Пополните баланс пользователя:
   ```
   POST http://localhost:5000/payments/topup?userId=user123&amount=100
   ```

3. Создайте заказ:
   ```
   POST http://localhost:5000/orders?userId=user123&amount=50&description=Test%20Order
   ```

4. Проверьте статус заказа (используйте ID, полученный при создании заказа):
   ```
   GET http://localhost:5000/orders/{orderId}
   ```

5. Проверьте обновленный баланс пользователя:
   ```
   GET http://localhost:5000/payments/balance?userId=user123
   ```

## Модульное тестирование

### Информация о тестах

В проекте реализованы модульные тесты с использованием xUnit для проверки основной функциональности сервисов Orders и Payments. Текущее покрытие кода тестами составляет **41%**.


### Тесты OrdersService:

- **OrdersControllerTests** - тесты для контроллера заказов
- **OrderModelTests** - тесты для модели заказа
- **OutboxEventTests** - тесты для событий Outbox

### Тесты PaymentsService:

- **PaymentsControllerTests** - тесты для контроллера платежей
- **AccountModelTests** - тесты для модели аккаунта
- **PaymentRequestConsumerTests** - тесты для обработчика запросов на оплату

### Запуск тестов

Для запуска всех модульных тестов выполните следующую команду:

```
dotnet test
```

Для запуска тестов отдельного проекта:

```
dotnet test OrdersService.Tests/OrdersService.Tests.csproj
```

или

```
dotnet test PaymentsService.Tests/PaymentsService.Tests.csproj
```

Для запуска тестов с отчетом о покрытии:

```
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura
```

## Структура проекта

- **APIGateway/** - сервис маршрутизации запросов
- **OrderService/** - сервис управления заказами
- **PaymentsService/** - сервис управления платежами
- **OrdersService.Tests/** - тесты для сервиса заказов
- **PaymentsService.Tests/** - тесты для сервиса платежей
- **front/** - фронтенд приложения
- **docker-compose.yml** - конфигурация Docker Compose для запуска всей системы

## Технические детали

### Обработка заказа

При создании заказа происходит следующая последовательность действий:

1. Orders Service создает новый заказ со статусом NEW
2. Orders Service отправляет сообщение в Redis о создании заказа
3. Payments Service получает сообщение и пытается списать средства со счета пользователя
4. Payments Service отправляет сообщение о результате оплаты (успех/неудача)
5. Orders Service получает сообщение о результате и обновляет статус заказа на FINISHED или CANCELLED
6. На сайте реализованно поддержка WebSocket

### Обеспечение надежности

- **Transactional Outbox**: гарантирует, что сообщение будет отправлено даже при сбое после сохранения данных
- **Transactional Inbox**: предотвращает повторную обработку сообщений
- **Оптимистичная блокировка**: предотвращает конфликты при параллельном изменении баланса

## Устранение неполадок

### Проблемы с CORS

Если вы столкнулись с ошибками CORS при обращении к API из браузера, убедитесь, что:

1. API Gateway правильно настроен для обработки CORS-запросов
2. Фронтенд использует правильные URL для обращения к API

### Проблемы с Docker

Если контейнеры не запускаются или работают некорректно:

1. Проверьте логи контейнеров:
   ```
   docker-compose logs
   ```

2. Перезапустите контейнеры:
   ```
   docker-compose down
   docker-compose up -d
   ```

3. Убедитесь, что порты не заняты другими приложениями

